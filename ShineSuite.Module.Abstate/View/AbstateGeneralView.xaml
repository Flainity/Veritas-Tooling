<UserControl x:Class="ShineSuite.Module.Abstate.View.AbstateGeneralView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:ShineSuite.Module.Abstate.View"
             xmlns:viewmodels="clr-namespace:ShineSuite.Module.Abstate.ViewModel"
             xmlns:converter="clr-namespace:ShineSuite.Common.Converter;assembly=ShineSuite.Common"
             xmlns:shinedata="clr-namespace:ShineData.Shine.Structure.Enum;assembly=ShineData"
             xmlns:system="clr-namespace:System;assembly=mscorlib"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:ui="http://schemas.inkore.net/lib/ui/wpf/modern"
             xmlns:ikw="http://schemas.inkore.net/lib/ui/wpf"
             xmlns:helper="clr-namespace:ShineSuite.Module.Abstate.Helper"
             mc:Ignorable="d"
             d:DesignHeight="1000" d:DesignWidth="1300" d:DataContext="{d:DesignInstance viewmodels:AbstateGeneralModel}">

    <UserControl.Resources>
        <converter:EnumDescriptionConverter x:Key="EnumDescriptionConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <ObjectDataProvider x:Key="SubState" MethodName="GetValues" ObjectType="{x:Type system:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="shinedata:SubState" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="SubAbstateAction" MethodName="GetValues" ObjectType="{x:Type system:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="shinedata:SubAbstateAction" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>

        <ObjectDataProvider x:Key="AbstateMemoryStruct" MethodName="GetValues" ObjectType="{x:Type system:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="shinedata:AbstateMemoryStruct" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        
        <ObjectDataProvider x:Key="StateType" MethodName="GetValues" ObjectType="{x:Type system:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="shinedata:StateType" />
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="40" />
            <RowDefinition Height="450" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <ui:ScrollViewerEx Grid.Row="0" HorizontalScrollBarVisibility="Hidden" VerticalScrollBarVisibility="Hidden">
            <ui:CommandBar DefaultLabelPosition="Right">
                <ui:CommandBar.PrimaryCommands>
                    <ui:AppBarButton Label="Save Abstates" Command="{Binding SaveAbstatesCommand}">
                        <ui:AppBarButton.Icon>
                            <ui:FontIcon Icon="{x:Static ui:SegoeFluentIcons.Save}"/>
                        </ui:AppBarButton.Icon>
                    </ui:AppBarButton>
                </ui:CommandBar.PrimaryCommands>
            </ui:CommandBar>
        </ui:ScrollViewerEx>

        <GroupBox Grid.Row="1" Header="Abstate">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="50"/>
                    <ColumnDefinition Width="150"/>
                    <ColumnDefinition Width="300"/>
                    <ColumnDefinition Width="300"/>
                    <ColumnDefinition Width="300"/>
                </Grid.ColumnDefinitions>
                
                <Image Grid.Column="0" Source="{Binding SelectedIcon}" Width="32" Height="32" VerticalAlignment="Top"
                       HorizontalAlignment="Center">
                    <Image.Effect>
                        <DropShadowEffect/>
                    </Image.Effect>
                </Image>
                
                <Canvas Grid.Column="1" Margin="5,0,0,0">
                    <Image Source="{Binding Icon}" MouseDown="UIElement_OnMouseDown" MouseLeftButtonUp="UIElement_OnMouseLeftButtonUp"/>
                    <Rectangle Width="16" Height="16" Stroke="White" StrokeThickness="2"
                               Canvas.Left="{Binding IconOverlayX}" Canvas.Top="{Binding IconOverlayY}" />
                </Canvas>
                
                <ikw:SimpleStackPanel Grid.Column="2" Orientation="Vertical" Margin="5" Spacing="5">
                    <Grid>
                        <TextBox ui:ControlHelper.Header="Index" Text="{Binding SelectedAbState.InxName, UpdateSourceTrigger=PropertyChanged}"/>
                    </Grid>
                    <Grid>
                        <ui:AutoSuggestBox ui:ControlHelper.Header="SubAbstate" 
                                           Text="{Binding SelectedAbState.SubAbstate}"
                                           TextChanged="SubabstateSelection_OnTextChanged"
                                           SuggestionChosen="SubabstateSelection_OnSuggestionChosen"
                                           />
                    </Grid>
                    <Grid>
                        <ComboBox ui:ControlHelper.Header="Memory Type" HorizontalAlignment="Stretch"
                                  ItemsSource="{Binding Source={StaticResource AbstateMemoryStruct}}"
                                  SelectedItem="{Binding SelectedAbstateMemory.AbstateMemoryStruct}"
                                  IsEnabled="{Binding IsAbstateMemoryVisible}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Path=., Converter={StaticResource EnumDescriptionConverter}}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </Grid>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition/>
                            <RowDefinition/>
                            <RowDefinition/>
                        </Grid.RowDefinitions>
                
                        <TextBox Grid.Row="0" Grid.RowSpan="3" 
                                 ui:ControlHelper.Header="Description"
                                 ui:ControlHelper.Description="Accepts a formatting pattern"
                                 Text="{Binding SelectedAbstateView.Description}" 
                                 TextWrapping="Wrap"
                                 Height="150"/>
                    </Grid>
                </ikw:SimpleStackPanel>
                
                <ikw:SimpleStackPanel Grid.Column="3" Orientation="Vertical" Margin="5" Spacing="5">
                    <Grid>
                        <ui:AutoSuggestBox ui:ControlHelper.Header="Icon File" HorizontalAlignment="Stretch"
                                           Text="{Binding SelectedAbstateView.IconFile}"
                                           TextChanged="IconFile_OnTextChanged"
                                           SuggestionChosen="IconFile_OnSuggestionChosen"/>
                    </Grid>
                    <Grid>
                        <ComboBox ui:ControlHelper.Header="Effect Type" HorizontalAlignment="Stretch"
                                  ItemsSource="{Binding EffectTypeOptions}"
                                  SelectionChanged="EffectType_OnSelectionChanged"
                                  SelectedItem="{Binding SelectedAbstateView.IconSort, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                    </Grid>
                    <Grid>
                        <ComboBox ui:ControlHelper.Header="Icon Sorting" HorizontalAlignment="Stretch"
                                  x:Name="IconSortComboBox"
                                  ItemsSource="{Binding Source={StaticResource StateType}}"
                                  SelectedItem="{Binding SelectedAbstateView.TypeSort}"
                                  IsEnabled="{Binding IsAbstateBuff}">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Path=., Converter={StaticResource EnumDescriptionConverter}}" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </Grid>
                    <Grid>
                        <ui:NumberBox ui:ControlHelper.Header="Party Range" HorizontalAlignment="Stretch"
                                  Text="{Binding SelectedAbState.PartyRange}"/>
                    </Grid>
                </ikw:SimpleStackPanel>
                
                <ikw:SimpleStackPanel Grid.Column="4" Orientation="Vertical" Margin="5" Spacing="5">
                    <Grid>
                        <ui:AutoSuggestBox ui:ControlHelper.Header="Party Effect (1 Member)" 
                                           Text="{Binding SelectedAbState.PartyState01}"
                                           TextChanged="PartyState01_OnTextChanged"
                                           SuggestionChosen="PartyState01_OnSuggestionChosen"
                                           IsEnabled="{Binding HasAbstateNoMainState}"
                        />
                    </Grid>
                    <Grid>
                        <ui:AutoSuggestBox ui:ControlHelper.Header="Party Effect (2 Members)" 
                                           Text="{Binding SelectedAbState.PartyState02}"
                                           TextChanged="PartyState02_OnTextChanged"
                                           SuggestionChosen="PartyState02_OnSuggestionChosen"
                                           IsEnabled="{Binding HasAbstateNoMainState}"
                        />
                    </Grid>
                    <Grid>
                        <ui:AutoSuggestBox ui:ControlHelper.Header="Party Effect (3 Members)" 
                                           Text="{Binding SelectedAbState.PartyState03}"
                                           TextChanged="PartyState03_OnTextChanged"
                                           SuggestionChosen="PartyState03_OnSuggestionChosen"
                                           IsEnabled="{Binding HasAbstateNoMainState}"
                        />
                    </Grid>
                    <Grid>
                        <ui:AutoSuggestBox ui:ControlHelper.Header="Party Effect (4 Members)" 
                                           Text="{Binding SelectedAbState.PartyState04}"
                                           TextChanged="PartyState04_OnTextChanged"
                                           SuggestionChosen="PartyState04_OnSuggestionChosen"
                                           IsEnabled="{Binding HasAbstateNoMainState}"
                        />
                    </Grid>
                    <Grid>
                        <ui:AutoSuggestBox ui:ControlHelper.Header="Party Effect (5 Members)" 
                                           Text="{Binding SelectedAbState.PartyState05}"
                                           TextChanged="PartyState05_OnTextChanged"
                                           SuggestionChosen="PartyState05_OnSuggestionChosen"
                                           IsEnabled="{Binding HasAbstateNoMainState}"
                        />
                    </Grid>
                    <Grid>
                        <ui:HyperlinkButton VerticalAlignment="Stretch" VerticalContentAlignment="Center"
                                            Content="Open Main Abstate" Click="MainAbstateButton_OnClick"
                                            Visibility="{Binding HasAbstateMainState, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </Grid>
                </ikw:SimpleStackPanel>
            </Grid>
        </GroupBox>

        <GroupBox Grid.Row="2" Header="Subabstate" IsEnabled="{Binding IsSubAbStateVisible}">
            <DataGrid ItemsSource="{Binding SelectedSubAbState}" AutoGenerateColumns="False" CanUserAddRows="False">
                <DataGrid.InputBindings>
                    <KeyBinding Key="N" Modifiers="Control" Command="{Binding AddNewSubAbstateCommand}" />
                </DataGrid.InputBindings>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Strength" Binding="{Binding Strength}" Width="100" />

                    <DataGridTemplateColumn Header="Type" Width="200">
                        <!-- Anzeige des ausgewählten Wertes (nicht editierbar) -->
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Type, Converter={StaticResource EnumDescriptionConverter}}" 
                                           VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>

                        <!-- Bearbeitungsmodus mit ComboBox -->
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox ItemsSource="{Binding Source={StaticResource SubState}}"
                                          SelectedItem="{Binding Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{DynamicResource {x:Type ComboBox}}" HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Sub Type" Binding="{Binding SubType}" Width="100" />
                    <DataGridTextColumn Header="Keep Time" Binding="{Binding KeepTime}" Width="100" />

                    <DataGridTemplateColumn Header="Action Index 01" Width="200">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ActionIndex01, Converter={StaticResource EnumDescriptionConverter}}" 
                                           VerticalAlignment="Center" Margin="10,0,0,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>

                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox ItemsSource="{Binding Source={StaticResource SubAbstateAction}}"
                                          SelectedItem="{Binding ActionIndex01, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{DynamicResource {x:Type ComboBox}}" HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Action Argument 01" Binding="{Binding ActionArg01}" Width="100" />

                    <DataGridTemplateColumn Header="Action Index 02" Width="200">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ActionIndex02, Converter={StaticResource EnumDescriptionConverter}}" 
                                           VerticalAlignment="Center" Margin="10,0,0,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>

                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox ItemsSource="{Binding Source={StaticResource SubAbstateAction}}"
                                          SelectedItem="{Binding ActionIndex02, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{DynamicResource {x:Type ComboBox}}" HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Action Argument 02" Binding="{Binding ActionArg02}" Width="100" />

                    <DataGridTemplateColumn Header="Action Index 03" Width="200">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ActionIndex03, Converter={StaticResource EnumDescriptionConverter}}" 
                                           VerticalAlignment="Center" Margin="10,0,0,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>

                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox ItemsSource="{Binding Source={StaticResource SubAbstateAction}}"
                                          SelectedItem="{Binding ActionIndex03, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{DynamicResource {x:Type ComboBox}}" HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Action Argument 03" Binding="{Binding ActionArg03}" Width="100" />

                    <DataGridTemplateColumn Header="Action Index 04" Width="200">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding ActionIndex04, Converter={StaticResource EnumDescriptionConverter}}" 
                                           VerticalAlignment="Center" Margin="10,0,0,0"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>

                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox ItemsSource="{Binding Source={StaticResource SubAbstateAction}}"
                                          SelectedItem="{Binding ActionIndex04, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                          Style="{DynamicResource {x:Type ComboBox}}" HorizontalAlignment="Stretch">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" />
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>

                    <DataGridTextColumn Header="Action Argument 04" Binding="{Binding ActionArg04}" Width="100" />
                </DataGrid.Columns>
            </DataGrid>
        </GroupBox>
    </Grid>
</UserControl>